<!DOCTYPE html>
<html lang="pt-pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../Css/estilo.css">
    <link rel="icon" href="../../Imagens/logo.jpg">
    <script src="https://kit.fontawesome.com/a563638dec.js" crossorigin="anonymous"></script>
    <title>MyTicket</title>
    <style>
        #user-name {
            text-decoration: none;
            /* Remove o sublinhado */
        }
    </style>
</head>

<body>

    <header class="header">
        <div>
            <div class="lista">
                <div>
                    <ul class="icon_menu">
                        <li id="navegacao"><i class="fa-solid fa-bars"></i></li>
                    </ul>
                </div>
                <div class="logo">
                    <li><a href="http://localhost:8080" id="myticket">MyTicket</a></li>
                </div>
                <div>
                    <ul class="nav_menu">
                        <li><a href="http://localhost:8080/admin" id="dashboard"><i
                                    class="fa-solid fa-screwdriver-wrench"></i></a>
                        </li>
                        <li><a href="#" id="perfil"><i class="fa-regular fa-user"></i></a>
                        </li>
                        <li><span id="user-name"></span><a href="#" id="sair"> <i
                                    class="fa-solid fa-right-from-bracket"></i></a>
                        </li>

                        <li id="carinho"><a href="#" id="carrinho" onclick="abrirmodalcarrinho()"><i
                                    class="fa-solid fa-cart-shopping"></i><span id="cart-count">0</span></a></li>

                    </ul>
                </div>
            </div>
        </div>
    </header>

    <!-- Modal de login-->
    <div id="modal-container" class="modal-container">
        <div class="modal">
            <span class="close-button">&times;</span>
            <img src="../../Imagens/logo.jpg" alt="Logo" class="admin">
            <h2>Login</h2>
            <form id="login">
                <label for="username">Email:</label><br>
                <input type="email" id="email" name="email"><br>
                <label for="password">Password:</label><br>
                <input type="password" id="password" name="password"><br>
                <a href="criarconta.html">Criar Conta</a>
                <input type="button" value="Login" class="botaolog" onclick="login()">
            </form>
        </div>
    </div>

    <!-- Modal de user-info nome e email e btao de logoutt-->
    <div id="user-info">
        <div class="user-info">

            <span class="close-button-user-info">&times;</span>

            <div>Conta: <span id="user-name"></span></div>

            <button id="logout"><i class="fa-solid fa-right-from-bracket"></i></button>

        </div>
    </div>





    <!-- Barra de navegação lateral-->
    <div class="nav-menu" id="navMenu">
        <div class="search_container">
            <input type="search" id="search" name="q" placeholder="Pesquisar...">
            <button type="submit" id="search-button"><i class="fas fa-search"></i></button>
        </div>
        <ul>

            <li>
                <h2>CATEGORIAS</h2>
            </li>
            <li><a href="#" data-categoria-id="1">Desporto</a></li>
            <li><a href="#" data-categoria-id="2">Cultura</a></li>
            <li><a href="#" data-categoria-id="3">Música</a></li>
            <li><a href="#" data-categoria-id="4">Arte</a></li>
            <li><a href="#" data-categoria-id="5">Educação</a></li>
            <li><a href="#" data-categoria-id="6">Viagens</a></li>
            <li><a href="#" data-categoria-id="7">Tecnologia</a></li>
        </ul>
    </div>


    <h3 class="titulo" id="tituloEventos">Próximos Eventos</h3>
    <section class="eventos" id="eventosContainer">
        <!-- Conteúdo da seção de eventos será inserido dinamicamente -->
    </section>

    <!-- Modal com informações de cada evento -->
    <div id="myModal" class="modal-eventos">
        <span class="close" onclick="closeModal()">&times;</span>
        <div id="caption">
            <h3 id="modalNome"></h3>
            <p id="modalData"></p>
            <p id="modalLocal"></p>
            <p id="modalDescricao"></p>
            <p id="modalPreco"></p>
            <button class="botao" id="comprarBilhete" onclick="adicionarItemAoCarrinho()">Adicionar ao carrinho</button>
        </div>
    </div>


    <!-- Modal de carrinho de compras -->
    <div id="modalCarrinho" class="modal-carrinho">
        <span class="close-button-carrinho">&times;</span>
        <h2>Carrinho de Compras</h2>
        <ul id="listaCarrinho">
            <!-- Lista de itens do carrinho será renderizada aqui -->
        </ul>
        <div class="total">
            <p>Total: € <span id="totalCarrinho">0.00</span></p>
        </div>
        <button class="botao" id="finalizarCompra">Finalizar Compra</button>
    </div>



    <a href="#" class="botao-voltar-topo" id="botaoVoltarTopo"><i class="fa-solid fa-up-long"></i></a>


    <!-- Rodape do site-->
    <footer>
        <div class="menu">
            <ul>
                <li><a href="index.html">Página Inicial</a></li>
            </ul>
        </div>
        <div class="empresa">
            <h3>Sobre Nossa Empresa</h3>
            <p>A MyTicket é uma plataforma líder na venda de bilhetes para uma ampla variedade de eventos.<br>Desde
                grandes festivais até eventos locais, estamos aqui para conectar você aos melhores momentos.</p>
        </div>
        <div class="copy">
            &copy; 2024 MyTicket. Todos os direitos reservados.
        </div>
    </footer>

</body>

<script>
    window.onload = function () {
        getCarrinho();
        listarItensDoCarrinho();
        // Verifica se o token existe no localStorage
        if (localStorage.getItem('token') !== null) {
            // Esconde o elemento com o id 'perfil'
            document.getElementById('perfil').style.display = 'none';

            // Recupera os dados do utilizador do localStorage e parseia o JSON
            const user = JSON.parse(localStorage.getItem('user'));

            // Verifica se o utilizador existe e obtém o nome do utilizador
            const userName = user ? user.nome : null;

            // Verifica se o utilizador é admin
            const isAdmin = user ? user.isAdmin : null;

            // Se o utilizador não for admin, remove o dashboard
            if (isAdmin !== true) {
                document.getElementById('dashboard').style.display = 'none';
            }

            // Verifica se o nome do utilizador existe e atualiza o conteúdo do elemento 'user-name'
            if (userName) {
                document.getElementById('user-name').textContent = userName;
            }
        }
    }


    window.addEventListener('scroll', function () {

        var botaoVoltarTopo = document.getElementById('botaoVoltarTopo');

        // Mostra o botão quando o utilizador rolar a página para baixo
        if (window.scrollY > 100) {
            botaoVoltarTopo.style.display = 'block';
        } else {
            botaoVoltarTopo.style.display = 'none';
        }
    });
    // Função para rolar a página de volta ao topo
    function voltarAoTopo() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }
    function fecharMenu() {
        document.getElementById("navMenu").classList.remove("open");
        document.getElementById('navegacao').style.display = 'block';
        document.body.classList.remove("menu-aberto");
    }
    document.getElementById('sair').onclick = function () {
        localStorage.removeItem('token');
        location.reload();
    };

    document.getElementById('perfil').addEventListener('click', function () {
        // verificar se existe token se nao, mostrar  modal container de login se sim mostrar botao logout
        if (localStorage.getItem('token') == null) {
            document.getElementById('modal-container').style.display = 'block';
        } else {
            document.getElementById('sair').style.display = 'block';
        }


    });

    document.querySelector('.close-button').addEventListener('click', function () {
        document.getElementById('modal-container').style.display = 'none';
    });

    document.querySelector('.close-button-user-info').addEventListener('click', function () {
        document.getElementById('user-info').style.display = 'none';
    });

    window.addEventListener('click', function (event) {
        if (event.target == document.getElementById('modal-container')) {
            document.getElementById('modal-container').style.display = 'none';
        }
    });


    document.addEventListener("DOMContentLoaded", function () {

        if (localStorage.getItem('token') == null) {
            document.getElementById('carinho').style.display = 'none';
            document.getElementById('sair').style.display = 'none';
            document.getElementById('dashboard').style.display = 'none';
        }


        var navegacaoImg = document.getElementById("navegacao");
        var navMenu = document.getElementById("navMenu");
        // Função para fechar o menu





        // Abrir o menu quando a imagem de navegação for clicada
        navegacaoImg.addEventListener("click", function () {
            navMenu.classList.toggle("open");
            document.getElementById('navegacao').style.display = 'none';
            document.body.classList.toggle("menu-aberto");
        });

        // Fechar o menu quando clicar fora dele
        document.addEventListener("click", function (event) {
            var clicadoDentroMenu = navMenu.contains(event.target);
            var clicadoNoIconeNavegacao = navegacaoImg.contains(event.target);
            if (!clicadoDentroMenu && !clicadoNoIconeNavegacao) {
                fecharMenu();
            }
        });
    });


    const login = async () => {
        var dados = {
            email: document.getElementById("email").value,
            password: document.getElementById("password").value,
        };
        const response = await fetch("http://localhost:8080/auth/login", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(dados),
        });

        console.log(response.ok);
        dados = await response.json();
        if (!response.ok) {
            alert("Erro ao fazer login");
        } else {
            alert("Login efetuado com sucesso");
            console.log("Token recebido:", dados.token); // Exibe o token no console

            // Guardar o token no local storage
            localStorage.setItem("token", dados.token);

            // Guardar os dados do utilizador no local storage
            localStorage.setItem("user", JSON.stringify(dados.user));

            window.location.href = "http://localhost:8080";
        }
    };



    document.addEventListener('DOMContentLoaded', function () {

        const eventosContainer = document.getElementById('eventosContainer');

        // Fazendo uma requisição AJAX para carregar os eventos do backend
        const xhr = new XMLHttpRequest();
        xhr.open('GET', 'http://localhost:8080/eventos/listar', true);
        xhr.onload = function () {
            if (xhr.status === 200) {
                const eventos = JSON.parse(xhr.responseText);
                eventos.forEach(evento => {
                    const cardEvento = `
                    <div class="card-evento">
                        <img src="${evento.foto}" alt="${evento.nome}">
                        <h3>${evento.nome}</h3>
                        <p>${evento.descricao || 'Descrição não disponível'}</p>
                        <button class="botao" id="mais" onclick="openModal(${evento.id})">Ver mais</button>
                    </div>
                `;
                    eventosContainer.innerHTML += cardEvento;
                });
            } else {
                console.error('Falha ao carregar os eventos.');
            }
        };
        xhr.send();
    });

    function openModal(eventId) {
        fetch(`http://localhost:8080/eventos/listar/${eventId}`)
            .then(response => response.json())
            .then(evento => {
                const dataFormatada = new Date(evento.data).toLocaleDateString('pt-PT', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                });

                // Preencha os dados do modal com as informações do evento
                document.getElementById('modalNome').textContent = evento.nome;
                document.getElementById('modalData').textContent = `Data: ${dataFormatada}`;
                document.getElementById('modalLocal').textContent = `Local: ${evento.localizacao}`;
                document.getElementById('modalDescricao').textContent = `Descrição: ${evento.descricao}`;
                document.getElementById('modalPreco').textContent = `Preço: ${evento.preco} €`;

                // Armazene o eventId no modal para uso posterior
                document.getElementById('myModal').setAttribute('data-event-id', eventId);
                localStorage.setItem('eventId', eventId);

                // Exiba o modal
                document.getElementById('myModal').style.display = 'block';
            })
            .catch(error => {
                console.error("Erro ao buscar os detalhes do evento:", error);
            });
    }






    function closeModal() {
        // Oculte o modal
        document.getElementById('myModal').style.display = 'none';
    }




    // Função para carregar os eventos por categoria
    function carregarEventosPorCategoria(categoriaId, categoriaNome) {
        document.getElementById('tituloEventos').textContent = categoriaNome;
        const eventosContainer = document.getElementById('eventosContainer');
        eventosContainer.innerHTML = ''; // Limpa os eventos anteriores

        // Faz uma requisição AJAX para carregar os eventos por categoria
        const xhr = new XMLHttpRequest();
        xhr.open('GET', `http://localhost:8080/eventos/listarcat/${categoriaId}`, true);
        xhr.onload = function () {
            if (xhr.status === 200) {
                const eventos = JSON.parse(xhr.responseText);
                eventos.forEach(evento => {
                    const cardEvento = `
                            <div class="card-evento">
                                <img src="${evento.foto}" alt="${evento.nome}">
                                <h3>${evento.nome}</h3>
                                <p>${evento.descricao || 'Descrição não disponível'}</p>
                                <button class="botao" id="mais" onclick="openModal(${evento.id})">Ver mais</button>
                            </div>
                        `;
                    eventosContainer.innerHTML += cardEvento;
                });
            } else {
                console.error('Falha ao carregar os eventos por categoria.');
            }
        };
        xhr.send();
    }

    // Event listener para carregar os eventos por categoria quando um link de categoria é clicado
    document.querySelectorAll('.nav-menu a').forEach(link => {
        link.addEventListener('click', function (event) {
            event.preventDefault(); // Evita o comportamento padrão de navegação
            const categoriaId = link.getAttribute('data-categoria-id');
            const categoriaNome = link.textContent;
            carregarEventosPorCategoria(categoriaId, categoriaNome);
        });
    });




    function abrirmodalcarrinho() {
        var modal = document.getElementById("modalCarrinho");
        modal.style.display = "block";
    }


    // Fechar o modal quando o utilizador clicar no 'X'
    var closeButton = document.getElementsByClassName("close-button-carrinho")[0];
    closeButton.onclick = function () {
        var modal = document.getElementById("modalCarrinho");
        modal.style.display = "none";
    }

    // PESQUISA
    const pesquisarEventos = async () => {
        const termoPesquisa = document.getElementById('search').value.trim();

        if (termoPesquisa.length === 0) {
            alert('Por favor, insira um termo de pesquisa válido.');
            return;
        }

        try {
            const response = await fetch(`http://localhost:8080/eventos/pesquisar?pesquisa=${termoPesquisa}`);
            const eventosPesquisados = await response.json();

            if (response.ok) {
                const eventosContainer = document.getElementById('eventosContainer');
                eventosContainer.innerHTML = ''; // Limpa os eventos anteriores
                fecharMenu();
                document.getElementById('tituloEventos').innerHTML = `Resultados em: <span style="color: blue;">${termoPesquisa}</span>`;



                eventosPesquisados.forEach(evento => {
                    const cardEvento = `
                        <div class="card-evento">
                            <img src="${evento.foto}" alt="${evento.nome}">
                            <h3>${evento.nome}</h3>
                            <p>${evento.descricao || 'Descrição não disponível'}</p>
                            <button class="botao" id="mais" onclick="openModal(${evento.id})">Ver mais</button>
                        </div>
                    `;
                    eventosContainer.innerHTML += cardEvento;
                });
            } else {
                const eventosContainer = document.getElementById('eventosContainer');
                eventosContainer.innerHTML = ''; // Limpa os eventos anteriores
                fecharMenu();
                document.getElementById('tituloEventos').innerHTML = `Nenhum resultado  em: <span style="color: blue;">${termoPesquisa}</span>`;




            }
        } catch (error) {
            console.error('Erro ao pesquisar eventos:', error);
            alert('Erro ao pesquisar eventos. Por favor, tente novamente mais tarde.');
        }
    };

    // Adiciona um event listener para o botão de pesquisa
    document.getElementById('search-button').addEventListener('click', pesquisarEventos);

    // Adiciona um event listener para a tecla Enter no campo de pesquisa
    document.getElementById('search').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            pesquisarEventos();


        }
    });


    // funcao para criar o carrinho do utilizador usando rota http://localhost:8080/carrinho/adicionar/utilizadorId, se o utilizador dar ja tem carrinho associado dizer na consola
    async function criarCarrinho() {
        try {
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user || !user.id) {
                console.error('ID do utilizador não encontrado no localStorage');
                return;
            }
            const utilizadorId = user.id;

            const response = await fetch(`http://localhost:8080/carrinho/adicionar/${utilizadorId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const carrinho = await response.json();
                console.log(carrinho);
                // quero guardar o id deste carrinho criado
                localStorage.setItem('carrinhoId', carrinho.id);
            } else {
                console.log('Erro ao criar carrinho:', response.status);
            }
        } catch (error) {
            console.error('Erro ao criar carrinho:', error);
        }
    }


    // Função para obter o carrinho do utilizador
    async function getCarrinho() {
        try {
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user || !user.id) {
                console.error('ID do utilizador não encontrado no localStorage');
                return;
            }
            const utilizadorId = user.id;
            const response = await fetch(`http://localhost:8080/carrinho/listar/${utilizadorId}`);
            if (response.ok) {
                const carrinho = await response.json();
                console.log(carrinho);
                localStorage.setItem('carrinhoId', carrinho.id);
            } else {
                console.error('Erro ao obter carrinho do utilizador');
                criarCarrinho();
            }
        } catch (error) {
            console.error('Erro ao obter carrinho do utilizador:', error);
        }
    }





    // funcao para adicionar item ao carrinho, id do item no localstorage usar fetch com rota
    async function adicionarItemAoCarrinho() {
        try {
            const carrinhoId = parseInt(localStorage.getItem('carrinhoId'), 10);
            const eventoId = parseInt(localStorage.getItem('eventId'), 10);

            if (isNaN(carrinhoId)) {
                console.error('ID do carrinho não encontrado ou inválido no localStorage');
                return;
            }

            if (isNaN(eventoId)) {
                console.error('ID do evento não encontrado ou inválido no localStorage');
                return;
            }

            const dados = {
                carrinhoId: carrinhoId,
                eventoId: eventoId,
                quantidade: 1
            };

            const response = await fetch(`http://localhost:8080/itens/adicionarEvento`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dados)
            });

            console.log(dados);

            if (!response.ok) {
                throw new Error('Erro ao adicionar item ao carrinho');
            }

            const resultado = await response.json();
            console.log('Item adicionado com sucesso:', resultado);
            listarItensDoCarrinho();

        } catch (error) {
            console.error('Erro ao adicionar item ao carrinho:', error);
        }
    }


    // funcao para listar os itens no modal do carrinho
    async function listarItensDoCarrinho() {
    try {
        const carrinhoId = localStorage.getItem('carrinhoId');
        if (isNaN(carrinhoId)) {
            console.error('ID do carrinho não encontrado ou inválido no localStorage');
            return;
        }
        const response = await fetch(`http://localhost:8080/itens/listarEventos/${carrinhoId}`);
        if (response.ok) {
            const resultado = await response.json();
            const listaCarrinho = document.getElementById('listaCarrinho');
            listaCarrinho.innerHTML = '';
            let total = 0;
            resultado.forEach((item) => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `
                    <span>${item.evento.nome}</span>
                    <span>€ ${item.evento.preco}</span>
                    <button class="botao-quantidade" data-action="minus">-</button>
                    <span class="quantidade">${item.quantidade}</span>
                    <button class="botao-quantidade" data-action="plus">+</button>
                `;
                listaCarrinho.appendChild(listItem);
                total += item.evento.preco * item.quantidade;
            });
            document.getElementById('totalCarrinho').textContent = total.toFixed(2);
        } else {
            console.error('Erro ao listar itens do carrinho');
        }
    } catch (error) {
        console.error('Erro ao listar itens do carrinho:', error);
    }
}




// fazer com que o botao de remover item funciona, aumentar e diminuir quantidade
// corrigir a estrutura e css do carrionho






</script>

</html>